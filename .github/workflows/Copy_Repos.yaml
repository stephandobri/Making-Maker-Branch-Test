# This GitHUb Action copies repos based on a text file that indicates which repos to copy

# To run, this file requires a separate file, Included_Device_Repos.txt to be in the same folder as this file.

name: Copy_Device_Repositories

# Choose how to trigger the workflow
on:
    # Trigger the workflow manually
    workflow_dispatch:
    # Trigger the workflow on a schedule. In this case, once at midnight, and once at noon.
    #schedule:
    #    - cron: '0 0,12 * * *'

jobs:
    # Read the file contents from the CSV in the repo
    file_contents:
        runs-on: ubuntu-latest
        outputs:
              device_repos: ${{ steps.read_file.outputs.device_repos }}
        steps:
        # Checkout the kit repo
        - name: Checkout the kit repo
          uses: actions/checkout@v6
          env:
              KIT_REPO_PATH: ${{ github.repository }}
        
        - name: Double check Kit Repo Path
          run: echo "$KIT_REPO_PATH"
          
        # Install python dependencies for the next step
        - name: Install Python dependencies
          run: python -m pip install --upgrade pip pandas
        
        # Read the file that includes all the repos
        - name: Read repo names
          id: read_file
          
          # Use python to read the CSV file and create a dynamic matrix with all the devices to add to the kit repo
          shell: python
          run: |
              # Import the requesite python libraries
              import pandas
              import json
              import os
              # Read the file
              included_devices = pandas.read_csv('.github/workflows/Included_Devices.csv', skipinitialspace=True, usecols=["RepoName"])
              # Print out what has been read for debugging
              print(included_devices.RepoName)
              # Pandas uses a different data type that doesn't work with the next function, so change it from a series to a list data type
              device_list = included_devices.RepoName.tolist()
              # Print the new list for debugginb
              print(device_list)
              # Convert the list to JSON format for the matrix in the next step
              devices = json.dumps(device_list)
              # Print out the devices to include for debugging
              print(devices)
              # Pass the python variable "Devices" as a GitHub Output
              with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
                  print(f'device_repos={devices}', file=fh)

        - name: Check output
          id: check_repos
          run: |
              # Print out for debugging
              echo "${{ fromJson(steps.read_file.outputs.device_repos) }}"
              # echo "${{ steps.read_file.outputs.device_repos }}"

    create_matrix:
        runs-on: ubuntu-latest
        needs: file_contents
        # Make a matrix of repo names to run the next section of code with a matrix strategy
        strategy:
          matrix:
            devices: ${{ fromJson(needs.file_contents.outputs.device_repos) }}
            #devices: [Interact-Switch, MMC60_Assistive_Switch]

        steps:
        
        # Added for debugging and to not have this job empty.
        - name: Read through the files
          run: |
              echo "${{matrix.devices}}"
              echo "${{needs.file_contents.outputs.device_repos}}"
              
        # Checkout the device repo
        - name: Checkout device repo
          uses: actions/checkout@v6
          with:
              repository: makersmakingchange/${{matrix.devices}}
              fetch-depth: 0

        # Copy the maker files
        - name: Copy maker files
          run: bash $KIT_REPO_PATH/.github/workflows/open_maker_files.sh
          env:
              DESTINATION_PATH: ./${{matrix.devices}}  

        
                
            
